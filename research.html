<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock Research Decision Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 450px;
      margin: 20px auto;
      background: #121212;
      color: white;
      padding: 20px;
      border-radius: 8px;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      margin-right: 5px;
    }
    input {
      width: 70%;
      background: #222;
      color: white;
    }
    button {
      background: #e91e63;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    #output {
      margin-top: 20px;
      white-space: pre-wrap;
      line-height: 1.4;
    }
  </style>
</head>
<body>

<h2>Stock Research Decision Tool</h2>
<input type="text" id="symbol" placeholder="Enter Stock Symbol (e.g. AAPL)" value="AAPL" />
<button id="checkBtn">Check Stock</button>

<pre id="output">Enter a symbol and click "Check Stock"</pre>

<script>
  const apiKey = "d151vgpr01qntv1fni6gd151vgpr01qntv1fni70";

  // Helper to format change percentages or fallback
  function formatChange(val) {
    return val === null || val === undefined || isNaN(val) ? "N/A" : val.toFixed(2) + "%";
  }

  function upDown(change) {
    if (change === null || isNaN(change)) return "N/A";
    return change >= 0 ? "Up" : "Down";
  }

  // Calculate percentage change between two prices
  function calcChange(newPrice, oldPrice) {
    if (!newPrice || !oldPrice || oldPrice === 0) return null;
    return ((newPrice - oldPrice) / oldPrice) * 100;
  }

  async function fetchWeeklyCandles(symbol, weeks) {
    const to = Math.floor(Date.now() / 1000);
    const from = to - weeks * 7 * 24 * 60 * 60; // weeks ago in seconds

    const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=W&from=${from}&to=${to}&token=${apiKey}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.s !== 'ok') {
        return null;
      }
      return data;
    } catch {
      return null;
    }
  }

  async function fetchMetrics(symbol) {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${apiKey}`);
      const data = await res.json();
      return data.metric || null;
    } catch {
      return null;
    }
  }

  document.getElementById('checkBtn').addEventListener('click', async () => {
    const symbol = document.getElementById('symbol').value.trim().toUpperCase();
    const output = document.getElementById('output');
    output.textContent = "Loading data for " + symbol + "...";

    const [metrics, candles] = await Promise.all([
      fetchMetrics(symbol),
      fetchWeeklyCandles(symbol, 52) // 1 year weekly candles
    ]);

    // Initialize changes as null
    let oneDayChange = null; // N/A with weekly data
    let oneMonthChange = null;
    let sixMonthChange = null;
    let oneYearChange = null;
    let weekChange = null;
    let twoWeekChange = null;
    let monthChange = null;

    if (candles && candles.c && candles.c.length > 1) {
      const close = candles.c;
      const len = close.length;

      // Calculate momentum changes
      weekChange = len > 1 ? calcChange(close[len-1], close[len-2]) : null;
      twoWeekChange = len > 2 ? calcChange(close[len-1], close[len-3]) : null;
      oneMonthChange = len > 4 ? calcChange(close[len-1], close[len-5]) : null;
      sixMonthChange = len > 25 ? calcChange(close[len-1], close[len-26]) : null;
      oneYearChange = len > 51 ? calcChange(close[len-1], close[len-52]) : null;
      monthChange = oneMonthChange; // alias
    }

    // Fundamentals with fallback
    const peRatio = metrics && metrics.peNormalizedAnnual ? metrics.peNormalizedAnnual : null;
    const debtEquity = metrics && metrics.debtEquityAnnual ? metrics.debtEquityAnnual : null;
    const epsGrowth = metrics && metrics.epsGrowth ? metrics.epsGrowth : null;
    const dividendYield = metrics && metrics.dividendYieldAnnual ? metrics.dividendYieldAnnual : null;

    // Decision logic: simple heuristic
    let recommendation = "N/A";
    if (
      peRatio !== null && peRatio < 20 &&
      epsGrowth !== null && epsGrowth > 0 &&
      oneYearChange !== null && oneYearChange > 0 &&
      debtEquity !== null && debtEquity < 1 &&
      dividendYield !== null && dividendYield > 0.02 &&
      weekChange !== null && weekChange > 0 &&
      monthChange !== null && monthChange > 0
    ) {
      recommendation = "Consider Buying";
    } else if (
      peRatio !== null && peRatio > 30 &&
      oneYearChange !== null && oneYearChange < 0 &&
      debtEquity !== null && debtEquity > 2
    ) {
      recommendation = "Consider Selling or Avoid";
    }

    output.textContent =
`Price Changes

1 Day: N/A (weekly data)

1 Month: ${formatChange(oneMonthChange)} (${upDown(oneMonthChange)})
6 Months: ${formatChange(sixMonthChange)} (${upDown(sixMonthChange)})
1 Year: ${formatChange(oneYearChange)} (${upDown(oneYearChange)})

Momentum

This Week: ${formatChange(weekChange)} (${upDown(weekChange)})
Last 2 Weeks: ${formatChange(twoWeekChange)} (${upDown(twoWeekChange)})
This Month: ${formatChange(monthChange)} (${upDown(monthChange)})

Fundamentals

P/E Ratio: ${peRatio !== null ? peRatio.toFixed(2) : "N/A"}
Debt to Equity: ${debtEquity !== null ? debtEquity.toFixed(2) : "N/A"}
EPS Growth: ${epsGrowth !== null ? (epsGrowth*100).toFixed(2) + "%" : "N/A"}
Dividend Yield: ${dividendYield !== null ? (dividendYield*100).toFixed(2) + "%" : "N/A"}

Recommendation:
${recommendation}
`;
  });
</script>

</body>
</html>

