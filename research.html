<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Buy Decision Helper</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #eee;
      font-family: Arial, sans-serif;
      max-width: 350px;
      margin: 20px auto;
      padding: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    button {
      background-color: #e91e63;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #ad1457;
    }
    .result {
      margin-top: 20px;
      background-color: #2c2c2c;
      padding: 15px;
      border-radius: 8px;
    }
    .metric {
      margin-bottom: 10px;
    }
    .metric strong {
      display: block;
      font-size: 14px;
      color: #e91e63;
    }
    .verdict {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>Stock Buy Decision Helper</h2>

  <input id="stockSymbol" type="text" placeholder="Enter Stock Symbol (e.g. AAPL)" />
  <button id="fetchBtn">Check Stock</button>

  <div id="output" class="result" style="display:none;"></div>

  <script>
    const apiKey = "d151vgpr01qntv1fni6gd151vgpr01qntv1fni70";

    // Helper: format number with commas & 2 decimals
    const fmtNum = (n) => n !== null && n !== undefined ? n.toLocaleString(undefined, {maximumFractionDigits:2}) : "N/A";
    const fmtPct = (n) => n !== null && n !== undefined ? (n*100).toFixed(2) + "%" : "N/A";

    // Helper: get UNIX timestamp (seconds)
    function toUnix(date) { return Math.floor(date.getTime() / 1000); }

    // Helper: get percentage change
    function pctChange(start, end) {
      if (start === 0 || !start || !end) return null;
      return (end - start) / start;
    }

    // Fetch candles for symbol between from and to (unix timestamps)
    async function fetchCandles(symbol, from, to) {
      const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${apiKey}`;
      const res = await fetch(url);
      return res.json();
    }

    document.getElementById("fetchBtn").addEventListener("click", async () => {
      const symbol = document.getElementById("stockSymbol").value.trim().toUpperCase();
      if (!symbol) {
        alert("Please enter a stock symbol.");
        return;
      }
      const output = document.getElementById("output");
      output.style.display = "block";
      output.innerHTML = "Loading...";

      try {
        // Fetch quote data
        const quoteRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
        const quote = await quoteRes.json();

        // Fetch metric data
        const metricRes = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${apiKey}`);
        const metricData = await metricRes.json();

        if (quote.c === 0 || !metricData.metric) {
          output.innerHTML = "No data found for this symbol.";
          return;
        }

        const metrics = metricData.metric;

        const price = quote.c;
        const peRatio = metrics.peNormalizedAnnual ?? metrics.peAnnual ?? null;
        const epsGrowth = metrics.epsGrowth ?? null;
        const dividendYield = metrics.dividendYieldIndicatedAnnual ?? null;
        const debtEquity = metrics.debtToEquityAnnual ?? null;

        // Calculate dates for candles
        const now = new Date();
        const todayUnix = toUnix(now);

        // 1 day ago
        const oneDayAgo = new Date(now);
        oneDayAgo.setDate(now.getDate() - 1);

        // 1 month ago
        const oneMonthAgo = new Date(now);
        oneMonthAgo.setMonth(now.getMonth() - 1);

        // 6 months ago
        const sixMonthsAgo = new Date(now);
        sixMonthsAgo.setMonth(now.getMonth() - 6);

        // 1 year ago
        const oneYearAgo = new Date(now);
        oneYearAgo.setFullYear(now.getFullYear() - 1);

        // 1 week ago
        const oneWeekAgo = new Date(now);
        oneWeekAgo.setDate(now.getDate() - 7);

        // 2 weeks ago
        const twoWeeksAgo = new Date(now);
        twoWeeksAgo.setDate(now.getDate() - 14);

        // Start of this month
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        // Fetch candles for each period - we'll fetch a combined period for efficiency: from 1 year ago to now
        const candles = await fetchCandles(symbol, toUnix(oneYearAgo), todayUnix);

        if (candles.s !== "ok" || !candles.c || candles.c.length === 0) {
          output.innerHTML = "No historical data available.";
          return;
        }

        // Helper to find closest closing price at or before a given date
        function findCloseAt(date) {
          const unixDate = toUnix(date);
          let i = candles.t.findIndex(t => t >= unixDate);
          if (i === -1) i = candles.t.length - 1;
          else if (i > 0) i = i - 1; // get prior day's close if exact not found
          return candles.c[i];
        }

        // Calculate price changes
        const price1dAgo = findCloseAt(oneDayAgo);
        const price1mAgo = findCloseAt(oneMonthAgo);
        const price6mAgo = findCloseAt(sixMonthsAgo);
        const price1yAgo = findCloseAt(oneYearAgo);
        const price1wAgo = findCloseAt(oneWeekAgo);
        const price2wAgo = findCloseAt(twoWeeksAgo);
        const priceStartMonth = findCloseAt(startOfMonth);

        const change1d = pctChange(price1dAgo, price);
        const change1m = pctChange(price1mAgo, price);
        const change6m = pctChange(price6mAgo, price);
        const change1y = pctChange(price1yAgo, price);

        // Directional for week, 2 weeks, month (up/down)
        const weekDir = price > price1wAgo ? "Up" : "Down";
        const twoWeekDir = price > price2wAgo ? "Up" : "Down";
        const monthDir = price > priceStartMonth ? "Up" : "Down";

        // Build verdict based on extended heuristics
        let score = 0;

        if (peRatio && peRatio < 20) score++;
        if (epsGrowth && epsGrowth > 0) score++;
        if (dividendYield && dividendYield > 0.02) score++;
        if (debtEquity && debtEquity < 1) score++;

        // Adding price momentum scores
        if (change1d && change1d > 0) score++;
        if (change1m && change1m > 0) score++;
        if (change6m && change6m > 0) score++;
        if (change1y && change1y > 0) score++;

        // Weekly, biweekly, monthly direction add to score
        if (weekDir === "Up") score++;
        if (twoWeekDir === "Up") score++;
        if (monthDir === "Up") score++;

        // Final verdict
        let verdict = "";
        if (score >= 9) verdict = "Strong candidate for buying üëç";
        else if (score >= 6) verdict = "Potential buy - do further research ü§î";
        else verdict = "Consider waiting or researching more ‚ö†Ô∏è";

        // Render output
        output.innerHTML = `
          <div class="metric"><strong>Current Price:</strong> $${fmtNum(price)}</div>
          <div class="metric"><strong>PE Ratio:</strong> ${fmtNum(peRatio)}</div>
          <div class="metric"><strong>EPS Growth Estimate:</strong> ${fmtPct(epsGrowth)}</div>
          <div class="metric"><strong>Dividend Yield:</strong> ${fmtPct(dividendYield)}</div>
          <div class="metric"><strong>Debt to Equity Ratio:</strong> ${fmtNum(debtEquity)}</div>

          <div class="metric"><strong>1 Day Change:</strong> ${fmtPct(change1d)}</div>
          <div class="metric"><strong>1 Month Change:</strong> ${fmtPct(change1m)}</div>
          <div class="metric"><strong>6 Month Change:</strong> ${fmtPct(change6m)}</div>
          <div class="metric"><strong>1 Year Change:</strong> ${fmtPct(change1y)}</div>

          <div class="metric"><strong>This Week Trend:</strong> ${weekDir}</div>
          <div class="metric"><strong>Last 2 Weeks Trend:</strong> ${twoWeekDir}</div>
          <div class="metric"><strong>This Month Trend:</strong> ${monthDir}</div>

          <div class="verdict">${verdict}</div>
        `;

      } catch (error) {
        output.innerHTML = "Error fetching stock data.";
        console.error(error);
      }
    });
  </script>

</body>
</html>
