<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stock Metrics Comparison</title>
  <style>
    body {
      background: #1e1e1e;
      color: #eee;
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
    }
    button {
      background: #e91e63;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #444;
    }
    th {
      background: #333;
    }
  </style>
</head>
<body>

<h2>Compare Stock Metrics</h2>

<input id="symbolInput" placeholder="Enter symbol (e.g. AAPL)" />
<button id="fetchBtn">Fetch Data</button>

<table id="resultsTable" style="display:none;">
  <thead>
    <tr>
      <th>Metric</th>
      <th>Finnhub</th>
      <th>Alpha Vantage</th>
      <th>Twelve Data</th>
    </tr>
  </thead>
  <tbody id="resultsBody"></tbody>
</table>

<script>
  const FINNHUB_KEY = 'd151vgpr01qntv1fni6gd151vgpr01qntv1fni70';
  const ALPHA_KEY = '6SLAGSIEM2SXPAU7';
  const TWELVE_KEY = '7f4f3e58e9ba42afb0d4e004742a5e7f';

  const metricsList = [
    { key: 'price', label: 'Price' },
    { key: 'pe', label: 'P/E Ratio' },
    { key: 'epsGrowth', label: 'EPS Growth (Past)' },
    { key: 'epsForward', label: 'EPS Growth (Future)' },
    { key: 'divYield', label: 'Dividend Yield' },
    { key: 'deRatio', label: 'Debt / Equity' }
  ];

  document.getElementById('fetchBtn').onclick = async () => {
    const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
    if (!symbol) return alert('Please enter a stock symbol.');

    document.getElementById('resultsBody').innerHTML = '';
    document.getElementById('resultsTable').style.display = 'none';

    try {
      // Fetch data from Finnhub
      const [fRes, qRes] = await Promise.all([
        fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${FINNHUB_KEY}`).then(r => r.json()).catch(() => ({})),
        fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`).then(r => r.json()).catch(() => ({}))
      ]);
      const fm = fRes.metric || {};

      // Fetch data from Alpha Vantage
      const aRes = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_KEY}`)
        .then(r => r.json()).catch(() => ({}));
      const aq = aRes['Global Quote'] || {};

      // Fetch data from Twelve Data
      const tRes = await fetch(`https://api.twelvedata.com/price?symbol=${symbol}&apikey=${TWELVE_KEY}`)
        .then(r => r.json()).catch(() => ({}));

      const dataMap = {
        finn: {
          price: qRes.c ?? null,
          pe: fm.peNormalizedAnnual ?? fm.peAnnual ?? null,
          epsGrowth: fm.epsGrowth ?? null,
          epsForward: fm.epsForward ?? null,
          divYield: fm.dividendYieldIndicatedAnnual ?? null,
          deRatio: fm.debtToEquityAnnual ?? null
        },
        alpha: {
          price: parseFloat(aq['05. price']) || null,
          pe: null,
          epsGrowth: null,
          epsForward: null,
          divYield: null,
          deRatio: null
        },
        twelve: {
          price: parseFloat(tRes.price) || null,
          pe: null,
          epsGrowth: null,
          epsForward: null,
          divYield: null,
          deRatio: null
        }
      };

      const tbody = document.getElementById('resultsBody');

      metricsList.forEach(m => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${m.label}</td>
          <td>${format(dataMap.finn[m.key])}</td>
          <td>${format(dataMap.alpha[m.key])}</td>
          <td>${format(dataMap.twelve[m.key])}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('resultsTable').style.display = 'table';

    } catch (error) {
      alert("Error fetching data: " + error);
      console.error(error);
    }
  };

  function format(v) {
    if (v === null || v === undefined) return '-';
    if (typeof v === 'number' && v < 1 && v >= 0) return (v * 100).toFixed(2) + '%';
    return typeof v === 'number' ? v.toFixed(2) : v.toString();
  }
</script>

</body>
</html>
