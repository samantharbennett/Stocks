<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock Buy Decision Widget</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      max-width: 350px;
      margin: 20px auto;
      padding: 10px;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      border: none;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #00bcd4;
      color: white;
      cursor: pointer;
    }
    .metric {
      margin: 10px 0;
    }
    .metric b {
      display: block;
      font-size: 1.1em;
      margin-bottom: 2px;
    }
    .metric small {
      color: #bbb;
      font-size: 0.85em;
    }
    #output {
      margin-top: 20px;
      padding: 10px;
      background: #2c2c2c;
      border-radius: 6px;
      min-height: 100px;
    }
  </style>
</head>
<body>

<h2>Stock Information</h2>
<input type="text" id="symbolInput" placeholder="Enter stock symbol (e.g. LMT)" />
<button id="fetchButton">Get Stock Data</button>

<div id="output">Enter a symbol and click "Get Stock Data".</div>

<script>
  const apiKey = "d151vgpr01qntv1fni6gd151vgpr01qntv1fni70";
  const output = document.getElementById("output");

  // Convert date to UNIX timestamp (seconds)
  function toUnix(date) {
    return Math.floor(date.getTime() / 1000);
  }

  // Fetch stock metrics (fundamentals)
  async function fetchMetrics(symbol) {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${apiKey}`);
      const data = await res.json();
      if (data.metric) return data.metric;
      else throw new Error("No metric data");
    } catch (e) {
      console.error("fetchMetrics error:", e);
      return null;
    }
  }

  // Fetch candles (historical price data)
  async function fetchCandles(symbol, from, to) {
    try {
      const res = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${apiKey}`);
      const data = await res.json();
      return data;
    } catch (e) {
      console.error("fetchCandles error:", e);
      return null;
    }
  }

  // Calculate percent change between two prices
  function percentChange(oldPrice, newPrice) {
    return ((newPrice - oldPrice) / oldPrice) * 100;
  }

  // Determine if stock is up or down over period
  function upDown(percent) {
    return percent >= 0 ? "Up" : "Down";
  }

  // Main update function
  async function update() {
    const symbol = document.getElementById("symbolInput").value.trim().toUpperCase();
    if (!symbol) {
      output.innerHTML = "Please enter a stock symbol.";
      return;
    }

    output.innerHTML = "Loading data for " + symbol + "...";

    const now = new Date();
    const todayUnix = toUnix(now);

    // 1 year ago (set to 370 days back to cover weekends/holidays)
    const oneYearAgo = new Date(now);
    oneYearAgo.setDate(now.getDate() - 370);

    // 6 months ago (190 days)
    const sixMonthsAgo = new Date(now);
    sixMonthsAgo.setDate(now.getDate() - 190);

    // 1 month ago (30 days)
    const oneMonthAgo = new Date(now);
    oneMonthAgo.setDate(now.getDate() - 30);

    // 2 weeks ago (14 days)
    const twoWeeksAgo = new Date(now);
    twoWeeksAgo.setDate(now.getDate() - 14);

    // 1 week ago (7 days)
    const oneWeekAgo = new Date(now);
    oneWeekAgo.setDate(now.getDate() - 7);

    // Fetch fundamentals
    const metrics = await fetchMetrics(symbol);
    if (!metrics) {
      output.innerHTML = "Could not fetch fundamental metrics for " + symbol;
      return;
    }

    // Fetch 1 year candles (fallback to 6 months if empty)
    let candles = await fetchCandles(symbol, toUnix(oneYearAgo), todayUnix);
    console.log("1 year candles:", candles);
    if (!candles || candles.s !== "ok" || !candles.c || candles.c.length === 0) {
      console.warn("No 1 year data, trying 6 months");
      candles = await fetchCandles(symbol, toUnix(sixMonthsAgo), todayUnix);
      if (!candles || candles.s !== "ok" || !candles.c || candles.c.length === 0) {
        output.innerHTML = "No historical candle data available for " + symbol;
        return;
      }
    }

    // Helper to get closing price closest to a given date (or first available)
    function getClosePriceOnOrAfter(date) {
      const target = toUnix(date);
      for(let i = 0; i < candles.t.length; i++) {
        if(candles.t[i] >= target) return candles.c[i];
      }
      return candles.c[0]; // fallback first candle price
    }

    // Get prices at required dates
    const priceToday = candles.c[candles.c.length -1];
    const price1YearAgo = getClosePriceOnOrAfter(oneYearAgo);
    const price6MonthsAgo = getClosePriceOnOrAfter(sixMonthsAgo);
    const price1MonthAgo = getClosePriceOnOrAfter(oneMonthAgo);
    const price2WeeksAgo = getClosePriceOnOrAfter(twoWeeksAgo);
    const price1WeekAgo = getClosePriceOnOrAfter(oneWeekAgo);

    // Calculate % changes
    const change1Day = candles.c.length > 1 ? percentChange(candles.c[candles.c.length - 2], priceToday) : 0;
    const change1Month = percentChange(price1MonthAgo, priceToday);
    const change6Months = percentChange(price6MonthsAgo, priceToday);
    const change1Year = percentChange(price1YearAgo, priceToday);

    // Up/Down checks for week, 2 weeks, month
    const weeklyChange = percentChange(price1WeekAgo, priceToday);
    const twoWeekChange = percentChange(price2WeeksAgo, priceToday);
    const monthlyChange = change1Month;

    // Decision logic example:
    // Buy if:
    // - P/E ratio reasonable (< 30)
    // - Debt to equity < 1
    // - Stock trending up at least in last month
    // - Positive EPS growth
    // - Dividend yield > 0 (indicating return to shareholder)
    // - Price momentum mostly positive for week/2 week/month

    const pe = metrics.peNormalizedAnnual || metrics.peAnnual || 0;
    const debtEquity = metrics.debtToEquityAnnual || 0;
    const epsGrowth = metrics.epsGrowth || 0; // might be undefined
    const dividendYield = metrics.dividendYieldAnnual || 0;

    let buyScore = 0;
    if(pe > 0 && pe < 30) buyScore++;
    if(debtEquity > 0 && debtEquity < 1) buyScore++;
    if(epsGrowth > 0) buyScore++;
    if(dividendYield > 0) buyScore++;
    if(monthlyChange > 0) buyScore++;
    if(weeklyChange > 0) buyScore++;
    if(twoWeekChange > 0) buyScore++;

    const buyRecommendation = buyScore >= 5 ? "BUY" : "HOLD/SELL";

    output.innerHTML = `
      <div class="metric"><b>Price Changes</b>
        <small>1 Day: ${change1Day.toFixed(2)}% (${upDown(change1Day)})</small><br/>
        <small>1 Month: ${change1Month.toFixed(2)}% (${upDown(change1Month)})</small><br/>
        <small>6 Months: ${change6Months.toFixed(2)}% (${upDown(change6Months)})</small><br/>
        <small>1 Year: ${change1Year.toFixed(2)}% (${upDown(change1Year)})</small>
      </div>

      <div class="metric"><b>Momentum</b>
        <small>This Week: ${upDown(weeklyChange)}</small><br/>
        <small>Last 2 Weeks: ${upDown(twoWeekChange)}</small><br/>
        <small>This Month: ${upDown(monthlyChange)}</small>
      </div>

      <div class="metric"><b>Fundamentals</b>
        <small>P/E Ratio: ${pe.toFixed(2)}</small><br/>
        <small>Debt to Equity: ${debtEquity.toFixed(2)}</small><br/>
        <small>EPS Growth: ${epsGrowth.toFixed(2)}</small><br/>
        <small>Dividend Yield: ${dividendYield.toFixed(2)}</small>
      </div>

      <div class="metric"><b>Recommendation:</b> ${buyRecommendation}</div>
    `;
  }

  document.getElementById("fetchButton").addEventListener("click", update);
</script>

</body>
</html>
